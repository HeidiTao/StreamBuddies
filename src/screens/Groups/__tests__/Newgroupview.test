import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import NewGroupView from '../NewGroupView';
import { groupRepository } from '../../repositories/GroupRepository';

// Mock dependencies
jest.mock('../../repositories/GroupRepository');

const mockGroupRepository = groupRepository as jest.Mocked<typeof groupRepository>;

describe('NewGroupView', () => {
  const mockNavigation = {
    goBack: jest.fn(),
    navigate: jest.fn(),
  } as any;

  beforeEach(() => {
    jest.clearAllMocks();
    global.alert = jest.fn();
  });

  describe('Initial Render', () => {
    it('should display the header with title', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(getByText('Create new group')).toBeTruthy();
    });

    it('should display back button', () => {
      const { UNSAFE_root } = render(<NewGroupView navigation={mockNavigation} />);
      
      // Back button should be present
      expect(UNSAFE_root).toBeTruthy();
    });

    it('should display Group name input field', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(getByText('Group name')).toBeTruthy();
    });

    it('should display Description input field with optional label', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(getByText('Description')).toBeTruthy();
      expect(getByText('(optional)')).toBeTruthy();
    });

    it('should display member selection field', () => {
      const { getByText, getByPlaceholderText } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(getByText('Select up to 10 members')).toBeTruthy();
      expect(getByPlaceholderText('Start typing to search ...')).toBeTruthy();
    });

    it('should display Create button', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(getByText(/Create/)).toBeTruthy();
    });

    it('should display 6 default selected members', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(getByText('User name 1')).toBeTruthy();
      expect(getByText('User name 2')).toBeTruthy();
      expect(getByText('User name 3')).toBeTruthy();
      expect(getByText('User name 4')).toBeTruthy();
      expect(getByText('User name 5')).toBeTruthy();
      expect(getByText('User name 6')).toBeTruthy();
    });
  });

  describe('Group Name Input', () => {
    it('should update group name when text is entered', () => {
      const { getByText, getAllByDisplayValue } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      const groupNameInput = inputs[0]; // First empty input should be group name
      
      fireEvent.changeText(groupNameInput, 'Movie Night Crew');
      
      expect(groupNameInput.props.value).toBe('Movie Night Crew');
    });

    it('should handle empty group name', () => {
      const { getAllByDisplayValue } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      const groupNameInput = inputs[0];
      
      fireEvent.changeText(groupNameInput, '');
      
      expect(groupNameInput.props.value).toBe('');
    });
  });

  describe('Description Input', () => {
    it('should update description when text is entered', () => {
      const { getAllByDisplayValue } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      const descriptionInput = inputs[1]; // Second empty input should be description
      
      fireEvent.changeText(descriptionInput, 'Best group ever!');
      
      expect(descriptionInput.props.value).toBe('Best group ever!');
    });

    it('should allow multiline description', () => {
      const { getAllByDisplayValue } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      const descriptionInput = inputs[1];
      
      const multilineText = 'Line 1\nLine 2\nLine 3';
      fireEvent.changeText(descriptionInput, multilineText);
      
      expect(descriptionInput.props.value).toBe(multilineText);
    });
  });

  describe('Member Search', () => {
    it('should display suggestions when searching', () => {
      const { getByPlaceholderText, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, 'alice');
      
      expect(getByText('alice')).toBeTruthy();
    });

    it('should filter suggestions based on search text', () => {
      const { getByPlaceholderText, getByText, queryByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, 'al');
      
      expect(getByText('alice')).toBeTruthy();
      expect(queryByText('ben')).toBeNull();
    });

    it('should be case-insensitive', () => {
      const { getByPlaceholderText, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, 'ALICE');
      
      expect(getByText('alice')).toBeTruthy();
    });

    it('should not show already selected members in suggestions', () => {
      const { getByPlaceholderText, getAllByText, queryByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      
      // First add alice
      fireEvent.changeText(searchInput, 'alice');
      const aliceSuggestion = getAllByText('alice')[0];
      fireEvent.press(aliceSuggestion);
      
      // Search again
      fireEvent.changeText(searchInput, 'alice');
      
      // Alice should not appear in suggestions since already selected
      const aliceElements = getAllByText('alice');
      // Should only have 1 (the selected member), not in suggestions
    });

    it('should clear search after adding a member', () => {
      const { getByPlaceholderText, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, 'alice');
      
      const aliceSuggestion = getByText('alice');
      fireEvent.press(aliceSuggestion);
      
      expect(searchInput.props.value).toBe('');
    });

    it('should not show suggestions when search is empty', () => {
      const { getByPlaceholderText, queryByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, '');
      
      expect(queryByText('alice')).toBeNull();
    });
  });

  describe('Member Selection', () => {
    it('should add member when suggestion is clicked', () => {
      const { getByPlaceholderText, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, 'alice');
      
      const aliceSuggestion = getByText('alice');
      fireEvent.press(aliceSuggestion);
      
      // Alice should now be in selected members
      expect(getByText('alice')).toBeTruthy();
    });

    it('should display member initial in circle', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      // Default members should show their initials (A, B, C, D, E, F)
      expect(getByText('A')).toBeTruthy();
      expect(getByText('B')).toBeTruthy();
      expect(getByText('C')).toBeTruthy();
    });

    it('should not allow more than 10 members', () => {
      const { getByPlaceholderText, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      
      // Already have 6 members, add 4 more
      const membersToAdd = ['alice', 'ben', 'carla', 'dan'];
      membersToAdd.forEach(name => {
        fireEvent.changeText(searchInput, name);
        const suggestion = getByText(name);
        fireEvent.press(suggestion);
      });
      
      // Try to add 11th member
      fireEvent.changeText(searchInput, 'ella');
      const ellaSuggestion = getByText('ella');
      fireEvent.press(ellaSuggestion);
      
      expect(global.alert).toHaveBeenCalledWith('Maximum 10 members');
    });

    it('should not add duplicate members', () => {
      const { getByPlaceholderText, getByText, getAllByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      
      // Add alice
      fireEvent.changeText(searchInput, 'alice');
      let aliceSuggestion = getAllByText('alice')[0];
      fireEvent.press(aliceSuggestion);
      
      // Try to add alice again
      fireEvent.changeText(searchInput, 'alice');
      // Alice should not be in suggestions since already selected
    });
  });

  describe('Member Removal', () => {
    it('should remove member when X button is clicked', () => {
      const { getByText, queryByText, UNSAFE_root } = render(<NewGroupView navigation={mockNavigation} />);
      
      // Find the close button for member A
      // This would require adding testIDs to the close buttons for easier testing
      const closeButtons = UNSAFE_root.findAllByType('TouchableOpacity').filter(
        node => node.props.onPress?.toString().includes('removeMember')
      );
      
      if (closeButtons.length > 0) {
        fireEvent.press(closeButtons[0]);
      }
      
      // Member A should be removed
      // This test assumes the first member is removable
    });

    it('should display close button for all selected members', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      // All 6 default members should have close buttons
      // You'd verify this through testIDs or structure
      expect(getByText('User name 1')).toBeTruthy();
      expect(getByText('User name 2')).toBeTruthy();
    });
  });

  describe('Group Creation', () => {
    it('should call createGroup with correct data when Create is pressed', async () => {
      const mockCreatedGroup = {
        id: 'new-group-id',
        name: 'Test Group',
        description: 'Test description',
        code: 'TESTCO',
      };
      
      mockGroupRepository.createGroup = jest.fn().mockResolvedValue(mockCreatedGroup);

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      fireEvent.changeText(inputs[1], 'Test description');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.createGroup).toHaveBeenCalledWith(
          expect.objectContaining({
            name: 'Test Group',
            description: 'Test description',
            member_count: 6, // Default 6 members
          })
        );
      });
    });

    it('should navigate to GroupDetail after successful creation', async () => {
      const mockCreatedGroup = {
        id: 'new-group-id',
        name: 'Test Group',
        code: 'TESTCO',
      };
      
      mockGroupRepository.createGroup = jest.fn().resolvedValue(mockCreatedGroup);

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockNavigation.navigate).toHaveBeenCalledWith('GroupDetail', {
          group: mockCreatedGroup,
        });
      });
    });

    it('should show alert when group name is empty', async () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(global.alert).toHaveBeenCalledWith('Please enter a group name');
      });
    });

    it('should show alert when group name is only whitespace', async () => {
      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], '   ');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(global.alert).toHaveBeenCalledWith('Please enter a group name');
      });
    });

    it('should show alert when creation fails', async () => {
      mockGroupRepository.createGroup = jest.fn().mockRejectedValue(new Error('Creation failed'));

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(global.alert).toHaveBeenCalledWith('Failed to create group. Please try again.');
      });
    });

    it('should include created_by field in group data', async () => {
      mockGroupRepository.createGroup = jest.fn().mockResolvedValue({});

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.createGroup).toHaveBeenCalledWith(
          expect.objectContaining({
            created_by: 'demo-user',
          })
        );
      });
    });

    it('should include timestamps in group data', async () => {
      mockGroupRepository.createGroup = jest.fn().mockResolvedValue({});

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.createGroup).toHaveBeenCalledWith(
          expect.objectContaining({
            created_at: expect.any(Number),
            updated_at: expect.any(Number),
          })
        );
      });
    });

    it('should update member_count based on selected members', async () => {
      mockGroupRepository.createGroup = jest.fn().mockResolvedValue({});

      const { getByPlaceholderText, getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      
      // Add one more member
      const searchInput = getByPlaceholderText('Start typing to search ...');
      fireEvent.changeText(searchInput, 'alice');
      const aliceSuggestion = getByText('alice');
      fireEvent.press(aliceSuggestion);
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.createGroup).toHaveBeenCalledWith(
          expect.objectContaining({
            member_count: 7, // 6 default + 1 added
          })
        );
      });
    });
  });

  describe('Navigation', () => {
    it('should navigate back when back button is pressed', () => {
      const { UNSAFE_root } = render(<NewGroupView navigation={mockNavigation} />);
      
      const backButton = UNSAFE_root.findAllByType('TouchableOpacity')[0];
      fireEvent.press(backButton);
      
      expect(mockNavigation.goBack).toHaveBeenCalled();
    });
  });

  describe('Layout and Styling', () => {
    it('should render as a ScrollView', () => {
      const { UNSAFE_root } = render(<NewGroupView navigation={mockNavigation} />);
      
      expect(UNSAFE_root.findByType('ScrollView')).toBeTruthy();
    });

    it('should display members in a grid layout', () => {
      const { getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      // All 6 default members should be visible
      expect(getByText('User name 1')).toBeTruthy();
      expect(getByText('User name 2')).toBeTruthy();
      expect(getByText('User name 3')).toBeTruthy();
      expect(getByText('User name 4')).toBeTruthy();
      expect(getByText('User name 5')).toBeTruthy();
      expect(getByText('User name 6')).toBeTruthy();
    });
  });

  describe('Edge Cases', () => {
    it('should handle rapid member additions', () => {
      const { getByPlaceholderText, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const searchInput = getByPlaceholderText('Start typing to search ...');
      
      ['alice', 'ben', 'carla'].forEach(name => {
        fireEvent.changeText(searchInput, name);
        const suggestion = getByText(name);
        fireEvent.press(suggestion);
      });
      
      // Should have 9 members now (6 default + 3 added)
      expect(getByText('alice')).toBeTruthy();
      expect(getByText('ben')).toBeTruthy();
      expect(getByText('carla')).toBeTruthy();
    });

    it('should handle special characters in group name', async () => {
      mockGroupRepository.createGroup = jest.fn().mockResolvedValue({ id: '1' });

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test & Friends! ðŸŽ¬');
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.createGroup).toHaveBeenCalledWith(
          expect.objectContaining({
            name: 'Test & Friends! ðŸŽ¬',
          })
        );
      });
    });

    it('should handle empty description', async () => {
      mockGroupRepository.createGroup = jest.fn().mockResolvedValue({ id: '1' });

      const { getAllByDisplayValue, getByText } = render(<NewGroupView navigation={mockNavigation} />);
      
      const inputs = getAllByDisplayValue('');
      fireEvent.changeText(inputs[0], 'Test Group');
      // Leave description empty
      
      const createButton = getByText(/Create/);
      fireEvent.press(createButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.createGroup).toHaveBeenCalledWith(
          expect.objectContaining({
            description: '',
          })
        );
      });
    });
  });
});