import React from 'react';
import { render, fireEvent } from '@testing-library/react-native';
import GroupRowView from '../GroupRowView';
import { GroupDoc } from '../../sample_structs';

describe('GroupRowView', () => {
  const mockOnPress = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('Basic Rendering', () => {
    it('should display group name', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Movie Night',
        member_count: 5,
      };

      const { getByText, getAllByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Group name should appear twice (once in circle, once below)
      const groupNames = getAllByText('Movie Night');
      expect(groupNames).toHaveLength(2);
    });

    it('should render as a touchable component', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'TV Series Club',
        member_count: 3,
      };

      const { UNSAFE_root } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      const touchable = UNSAFE_root.findByType('TouchableOpacity');
      expect(touchable).toBeTruthy();
    });

    it('should apply correct background color to circle', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Anime Watchers',
        member_count: 8,
      };

      const { UNSAFE_root } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Check that the circle has the expected styling
      const view = UNSAFE_root.findAllByType('View')[1]; // Second View should be the circle
      expect(view.props.style).toEqual(
        expect.arrayContaining([
          expect.objectContaining({ backgroundColor: '#dfd6ff' })
        ])
      );
    });
  });

  describe('Member Display', () => {
    it('should display member initials for regular groups', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Regular Group',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Should display member initials S and M
      expect(getByText('S')).toBeTruthy();
      expect(getByText('M')).toBeTruthy();
    });

    it('should NOT display member initials for Create New Group', () => {
      const mockGroup: GroupDoc = {
        id: '0',
        name: 'Create New Group',
        member_count: 0,
      };

      const { queryByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Should not display member initials
      expect(queryByText('S')).toBeNull();
      expect(queryByText('M')).toBeNull();
    });

    it('should display exactly 2 member circles for regular groups', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 10, // Even with 10 members, should only show 2 initials
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText('S')).toBeTruthy();
      expect(getByText('M')).toBeTruthy();
    });
  });

  describe('Interaction', () => {
    it('should call onPress when touched', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      const touchable = getByText('Test Group').parent;
      if (touchable) {
        fireEvent.press(touchable);
      }
      
      expect(mockOnPress).toHaveBeenCalledTimes(1);
    });

    it('should be pressable multiple times', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { UNSAFE_root } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      const touchable = UNSAFE_root.findByType('TouchableOpacity');
      
      fireEvent.press(touchable);
      fireEvent.press(touchable);
      fireEvent.press(touchable);
      
      expect(mockOnPress).toHaveBeenCalledTimes(3);
    });
  });

  describe('Special Group Names', () => {
    it('should handle Create New Group name', () => {
      const mockGroup: GroupDoc = {
        id: '0',
        name: 'Create New Group',
        member_count: 0,
      };

      const { getAllByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      const groupNames = getAllByText('Create New Group');
      expect(groupNames).toHaveLength(2);
    });

    it('should handle empty group name', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: '',
        member_count: 0,
      };

      const { getAllByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Empty string should still render twice
      const emptyNames = getAllByText('');
      expect(emptyNames.length).toBeGreaterThan(0);
    });

    it('should handle very long group names', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'This is a very long group name that might cause layout issues if not handled properly',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText(/This is a very long group name/)).toBeTruthy();
    });

    it('should handle group names with special characters', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Friends & Family! ðŸŽ¬',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText('Friends & Family! ðŸŽ¬')).toBeTruthy();
    });
  });

  describe('Styling', () => {
    it('should apply groupStyles.circle to the circle view', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { UNSAFE_root } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // The second View should have the circle style
      const views = UNSAFE_root.findAllByType('View');
      expect(views.length).toBeGreaterThan(1);
    });

    it('should apply groupStyles.groupName to text', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { UNSAFE_root } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Should have Text components with groupName style
      const texts = UNSAFE_root.findAllByType('Text');
      expect(texts.length).toBeGreaterThan(0);
    });

    it('should apply groupStyles.membersRow when displaying members', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Members should be displayed (S and M)
      expect(getByText('S')).toBeTruthy();
      expect(getByText('M')).toBeTruthy();
    });

    it('should apply groupStyles.memberCircle to member circles', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Member circles should exist
      expect(getByText('S')).toBeTruthy();
      expect(getByText('M')).toBeTruthy();
    });

    it('should apply groupStyles.memberText to member initials', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      const memberS = getByText('S');
      const memberM = getByText('M');
      
      expect(memberS).toBeTruthy();
      expect(memberM).toBeTruthy();
    });
  });

  describe('Edge Cases', () => {
    it('should handle group with no id', () => {
      const mockGroup: GroupDoc = {
        name: 'No ID Group',
        member_count: 3,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText('No ID Group')).toBeTruthy();
    });

    it('should handle group with zero members', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Empty Group',
        member_count: 0,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      // Should still render with member initials
      expect(getByText('Empty Group')).toBeTruthy();
      expect(getByText('S')).toBeTruthy();
      expect(getByText('M')).toBeTruthy();
    });

    it('should handle undefined member_count', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test Group',
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText('Test Group')).toBeTruthy();
    });

    it('should render correctly with minimal group data', () => {
      const mockGroup: GroupDoc = {
        name: 'Minimal',
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText('Minimal')).toBeTruthy();
    });
  });

  describe('Props Validation', () => {
    it('should accept and use the group prop', () => {
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Prop Test',
        member_count: 5,
      };

      const { getByText } = render(
        <GroupRowView group={mockGroup} onPress={mockOnPress} />
      );
      
      expect(getByText('Prop Test')).toBeTruthy();
    });

    it('should accept and use the onPress prop', () => {
      const customOnPress = jest.fn();
      const mockGroup: GroupDoc = {
        id: '1',
        name: 'Test',
        member_count: 5,
      };

      const { UNSAFE_root } = render(
        <GroupRowView group={mockGroup} onPress={customOnPress} />
      );
      
      const touchable = UNSAFE_root.findByType('TouchableOpacity');
      fireEvent.press(touchable);
      
      expect(customOnPress).toHaveBeenCalledTimes(1);
    });
  });
});