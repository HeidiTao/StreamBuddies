import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import GroupDetailView from '../GroupDetailView';
import { fetchTMDBDetails } from '../../utils/tmdbApi';
import { groupRepository } from '../../repositories/GroupRepository';

// Mock dependencies
jest.mock('../../utils/tmdbApi');
jest.mock('../../repositories/GroupRepository');

const mockFetchTMDBDetails = fetchTMDBDetails as jest.MockedFunction<typeof fetchTMDBDetails>;
const mockGroupRepository = groupRepository as jest.Mocked<typeof groupRepository>;

describe('GroupDetailView', () => {
  const mockNavigation = {
    goBack: jest.fn(),
    getParent: jest.fn(() => ({
      navigate: jest.fn(),
    })),
  } as any;

  const mockGroup = {
    id: '1',
    name: 'Test Group',
    code: 'ABC123',
    description: 'Test description',
    member_count: 5,
    currently_watching: [
      { tmdb_id: 1399, title: 'Game of Thrones' },
      { tmdb_id: 1396, title: 'Breaking Bad' },
    ],
    finished: [
      { tmdb_id: 1418, title: 'The Big Bang Theory' },
    ],
  };

  const mockRoute = {
    params: { group: mockGroup },
  } as any;

  beforeEach(() => {
    jest.clearAllMocks();
    
    // Mock TMDB API responses
    mockFetchTMDBDetails.mockResolvedValue({
      id: 1,
      name: 'Test Show',
      poster_path: '/test.jpg',
      overview: 'Test overview',
    });
  });

  describe('Header Display', () => {
    it('should display group name', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('Test Group')).toBeTruthy();
    });

    it('should display group code in uppercase', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('ABC123')).toBeTruthy();
      expect(getByText('Group Code')).toBeTruthy();
    });

    it('should generate code from id if code is missing', () => {
      const groupWithoutCode = { ...mockGroup, code: undefined };
      const route = { params: { group: groupWithoutCode } } as any;
      
      const { getByText } = render(
        <GroupDetailView route={route} navigation={mockNavigation} />
      );
      
      // Should display first 6 characters of id in uppercase
      expect(getByText('1'.slice(0, 6).toUpperCase())).toBeTruthy();
    });

    it('should display Leave Group button', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('Leave Group')).toBeTruthy();
    });

    it('should display Find New Media button', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('Find New Media')).toBeTruthy();
    });
  });

  describe('Currently Watching Section', () => {
    it('should display Currently Watching header', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/Currently Watching/)).toBeTruthy();
    });

    it('should fetch TMDB details for currently watching items', async () => {
      render(<GroupDetailView route={mockRoute} navigation={mockNavigation} />);
      
      await waitFor(() => {
        expect(mockFetchTMDBDetails).toHaveBeenCalledWith(1399, 'tv');
        expect(mockFetchTMDBDetails).toHaveBeenCalledWith(1396, 'tv');
      });
    });

    it('should display up to 4 currently watching items', async () => {
      const groupWithMany = {
        ...mockGroup,
        currently_watching: [
          { tmdb_id: 1, title: 'Show 1' },
          { tmdb_id: 2, title: 'Show 2' },
          { tmdb_id: 3, title: 'Show 3' },
          { tmdb_id: 4, title: 'Show 4' },
          { tmdb_id: 5, title: 'Show 5' },
        ],
      };
      const route = { params: { group: groupWithMany } } as any;
      
      render(<GroupDetailView route={route} navigation={mockNavigation} />);
      
      await waitFor(() => {
        expect(mockFetchTMDBDetails).toHaveBeenCalledTimes(8); // 4 for currently watching, 4 for finished
      });
    });

    it('should use default content when group has no currently watching items', () => {
      const groupWithoutContent = { ...mockGroup, currently_watching: [] };
      const route = { params: { group: groupWithoutContent } } as any;
      
      render(<GroupDetailView route={route} navigation={mockNavigation} />);
      
      // Should fetch default items
      expect(mockFetchTMDBDetails).toHaveBeenCalled();
    });

    it('should display "No data" when fetch fails', async () => {
      mockFetchTMDBDetails.mockRejectedValue(new Error('Fetch failed'));
      
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      await waitFor(() => {
        expect(getByText('No data')).toBeTruthy();
      });
    });
  });

  describe('Shared Services Section', () => {
    it('should display Shared Services header', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('Shared Services')).toBeTruthy();
    });

    it('should display all streaming services', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('Netflix')).toBeTruthy();
      expect(getByText('Hulu')).toBeTruthy();
      expect(getByText('HboMax')).toBeTruthy();
    });
  });

  describe('Finished Section', () => {
    it('should display Finished header', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/Finished/)).toBeTruthy();
    });

    it('should fetch TMDB details for finished items', async () => {
      render(<GroupDetailView route={mockRoute} navigation={mockNavigation} />);
      
      await waitFor(() => {
        expect(mockFetchTMDBDetails).toHaveBeenCalledWith(1418, 'tv');
      });
    });

    it('should use default finished content when group has none', () => {
      const groupWithoutFinished = { ...mockGroup, finished: [] };
      const route = { params: { group: groupWithoutFinished } } as any;
      
      render(<GroupDetailView route={route} navigation={mockNavigation} />);
      
      expect(mockFetchTMDBDetails).toHaveBeenCalled();
    });
  });

  describe('Predictions Section', () => {
    it('should display Predictions header', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/Predictions/)).toBeTruthy();
    });

    it('should display prediction text', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/I think Jess is gonna get with Winston/)).toBeTruthy();
      expect(getByText(/Is Paul gonna take over/)).toBeTruthy();
    });

    it('should display prediction authors', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/Isabelle/)).toBeTruthy();
      expect(getByText(/Jovanni/)).toBeTruthy();
    });
  });

  describe('Random Memory Section', () => {
    it('should display Random Memory header', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText('Random Memory')).toBeTruthy();
    });

    it('should display memory content', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/Arini predicted/)).toBeTruthy();
      expect(getByText(/The sequel will be terrible/)).toBeTruthy();
      expect(getByText('Correct!')).toBeTruthy();
    });

    it('should display time since memory', () => {
      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      expect(getByText(/4 months ago/)).toBeTruthy();
    });
  });

  describe('Navigation Actions', () => {
    it('should navigate to ExploreTab when Find New Media is pressed', () => {
      const mockParentNavigate = jest.fn();
      mockNavigation.getParent = jest.fn(() => ({
        navigate: mockParentNavigate,
      }));

      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      const findMediaButton = getByText('Find New Media');
      fireEvent.press(findMediaButton);
      
      expect(mockParentNavigate).toHaveBeenCalledWith('ExploreTab');
    });
  });

  describe('Leave Group Functionality', () => {
    it('should call deleteGroup when Leave Group is pressed', async () => {
      mockGroupRepository.deleteGroup = jest.fn().mockResolvedValue(undefined);

      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      const leaveButton = getByText('Leave Group');
      fireEvent.press(leaveButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.deleteGroup).toHaveBeenCalledWith('1');
      });
    });

    it('should navigate back after successfully leaving group', async () => {
      mockGroupRepository.deleteGroup = jest.fn().mockResolvedValue(undefined);

      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      const leaveButton = getByText('Leave Group');
      fireEvent.press(leaveButton);
      
      await waitFor(() => {
        expect(mockNavigation.goBack).toHaveBeenCalled();
      });
    });

    it('should show alert when leave group fails', async () => {
      mockGroupRepository.deleteGroup = jest.fn().mockRejectedValue(new Error('Delete failed'));
      global.alert = jest.fn();

      const { getByText } = render(
        <GroupDetailView route={mockRoute} navigation={mockNavigation} />
      );
      
      const leaveButton = getByText('Leave Group');
      fireEvent.press(leaveButton);
      
      await waitFor(() => {
        expect(global.alert).toHaveBeenCalledWith('Failed to leave group.');
      });
    });

    it('should not attempt to leave if group id is missing', async () => {
      const groupWithoutId = { ...mockGroup, id: undefined };
      const route = { params: { group: groupWithoutId } } as any;

      const { getByText } = render(
        <GroupDetailView route={route} navigation={mockNavigation} />
      );
      
      const leaveButton = getByText('Leave Group');
      fireEvent.press(leaveButton);
      
      await waitFor(() => {
        expect(mockGroupRepository.deleteGroup).not.toHaveBeenCalled();
      });
    });
  });

  describe('Edge Cases', () => {
    it('should handle missing group parameter', () => {
      const emptyRoute = { params: {} } as any;
      
      const { getByText } = render(
        <GroupDetailView route={emptyRoute} navigation={mockNavigation} />
      );
      
      // Should display "Group" as fallback name
      expect(getByText('Group')).toBeTruthy();
    });

    it('should handle group with no code or id', () => {
      const groupNoCode = { name: 'Test' };
      const route = { params: { group: groupNoCode } } as any;
      
      const { queryByText } = render(
        <GroupDetailView route={route} navigation={mockNavigation} />
      );
      
      // Should not display Group Code section
      expect(queryByText('Group Code')).toBeNull();
    });
  });
});