import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import JoinGroupView from '../JoinGroupView';

describe('JoinGroupView', () => {
  const mockNavigation = {
    goBack: jest.fn(),
  } as any;

  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('Initial Render', () => {
    it('should display the header with title', () => {
      const { getByText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      expect(getByText('Join group')).toBeTruthy();
    });

    it('should display back button', () => {
      const { getByTestId, UNSAFE_root } = render(<JoinGroupView navigation={mockNavigation} />);
      
      // The back button with arrow-back icon should be present
      expect(UNSAFE_root).toBeTruthy();
    });

    it('should display code input field', () => {
      const { getByPlaceholderText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      expect(getByPlaceholderText('Enter invitation code')).toBeTruthy();
    });

    it('should display disabled Enter button initially', () => {
      const { getByText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      const enterButton = getByText('Enter');
      expect(enterButton).toBeTruthy();
    });

    it('should not display group details initially', () => {
      const { queryByText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      expect(queryByText(/invited you to the group/)).toBeNull();
      expect(queryByText('Members')).toBeNull();
    });
  });

  describe('Code Input', () => {
    it('should update code state when text is entered', () => {
      const { getByPlaceholderText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      
      expect(input.props.value).toBe('ABC123');
    });

    it('should enable Enter button when code is entered', () => {
      const { getByPlaceholderText, getByText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      
      const enterButton = getByText('Enter');
      expect(enterButton).toBeTruthy();
    });

    it('should keep Enter button disabled for empty or whitespace-only code', () => {
      const { getByPlaceholderText } = render(<JoinGroupView navigation={mockNavigation} />);
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, '   ');
      
      // Button should remain disabled (you'd need to check the disabled prop)
    });

    it('should hide details when code changes after showing details', () => {
      const { getByPlaceholderText, getByText, queryByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      
      const enterButton = getByText('Enter');
      fireEvent.press(enterButton);
      
      // Details should be visible
      expect(getByText(/invited you to the group/)).toBeTruthy();
      
      // Change code
      fireEvent.changeText(input, 'XYZ789');
      
      // Details should be hidden
      expect(queryByText(/invited you to the group/)).toBeNull();
    });
  });

  describe('Group Details Display', () => {
    it('should show group details when Enter is pressed with valid code', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      
      const enterButton = getByText('Enter');
      fireEvent.press(enterButton);
      
      expect(getByText(/Riya invited you to the group/)).toBeTruthy();
      expect(getByText('Besties!')).toBeTruthy();
    });

    it('should display group description', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      expect(getByText('Description')).toBeTruthy();
      expect(getByText('Coolest group for the coolest people ;)')).toBeTruthy();
    });

    it('should display Members section with all mock members', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      expect(getByText('Members')).toBeTruthy();
      expect(getByText('jo_vanni67')).toBeTruthy();
      expect(getByText('neptunelunal')).toBeTruthy();
      expect(getByText('arini_yayy')).toBeTruthy();
      expect(getByText('anui_cats')).toBeTruthy();
      expect(getByText('bobbi_buggy')).toBeTruthy();
      expect(getByText('ella_sarr')).toBeTruthy();
    });

    it('should display member initials', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      // Check for member initials A, B, C, D, E, F
      expect(getByText('A')).toBeTruthy();
      expect(getByText('B')).toBeTruthy();
      expect(getByText('C')).toBeTruthy();
      expect(getByText('D')).toBeTruthy();
      expect(getByText('E')).toBeTruthy();
      expect(getByText('F')).toBeTruthy();
    });

    it('should display Options section', () => {
      const { getByPlaceholderText, getByText, getAllByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      expect(getByText('Options')).toBeTruthy();
      const options = getAllByText('Share subscription info with group');
      expect(options).toHaveLength(2);
    });

    it('should display Join button', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      expect(getByText(/Join/)).toBeTruthy();
    });
  });

  describe('Options Interaction', () => {
    it('should toggle first option when clicked', () => {
      const { getByPlaceholderText, getByText, getAllByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      const options = getAllByText('Share subscription info with group');
      fireEvent.press(options[0]);
      
      // State should change (checkbox should be checked)
      // You'd verify this through the checkbox styling or testID
    });

    it('should toggle second option when clicked', () => {
      const { getByPlaceholderText, getByText, getAllByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      const options = getAllByText('Share subscription info with group');
      fireEvent.press(options[1]);
      
      // State should change
    });

    it('should allow both options to be toggled independently', () => {
      const { getByPlaceholderText, getByText, getAllByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      const options = getAllByText('Share subscription info with group');
      fireEvent.press(options[0]);
      fireEvent.press(options[1]);
      
      // Both should be toggled
    });
  });

  describe('Navigation', () => {
    it('should navigate back when back button is pressed', () => {
      const { UNSAFE_root } = render(<JoinGroupView navigation={mockNavigation} />);
      
      // Find and press the back button
      // Note: You might need to add a testID to the back button for easier testing
      const backButton = UNSAFE_root.findAllByType('TouchableOpacity')[0];
      fireEvent.press(backButton);
      
      expect(mockNavigation.goBack).toHaveBeenCalled();
    });
  });

  describe('Edge Cases', () => {
    it('should not show details when Enter is pressed with empty code', () => {
      const { getByText, queryByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      // Try to press Enter without entering code (should be disabled)
      const enterButton = getByText('Enter');
      // Button should be disabled, but if somehow pressed:
      
      expect(queryByText(/invited you to the group/)).toBeNull();
    });

    it('should handle rapid code changes', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      
      fireEvent.changeText(input, 'ABC');
      fireEvent.changeText(input, 'ABC1');
      fireEvent.changeText(input, 'ABC12');
      fireEvent.changeText(input, 'ABC123');
      
      fireEvent.press(getByText('Enter'));
      
      expect(getByText(/invited you to the group/)).toBeTruthy();
    });

    it('should handle empty whitespace code gracefully', () => {
      const { getByPlaceholderText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, '     ');
      
      // Enter button should remain disabled
    });
  });

  describe('Styling and Layout', () => {
    it('should display members in a grid layout', () => {
      const { getByPlaceholderText, getByText } = render(
        <JoinGroupView navigation={mockNavigation} />
      );
      
      const input = getByPlaceholderText('Enter invitation code');
      fireEvent.changeText(input, 'ABC123');
      fireEvent.press(getByText('Enter'));
      
      // All 6 members should be visible
      expect(getByText('jo_vanni67')).toBeTruthy();
      expect(getByText('neptunelunal')).toBeTruthy();
      expect(getByText('arini_yayy')).toBeTruthy();
      expect(getByText('anui_cats')).toBeTruthy();
      expect(getByText('bobbi_buggy')).toBeTruthy();
      expect(getByText('ella_sarr')).toBeTruthy();
    });

    it('should render as a ScrollView', () => {
      const { UNSAFE_root } = render(<JoinGroupView navigation={mockNavigation} />);
      
      // The root component should be a ScrollView
      expect(UNSAFE_root.findByType('ScrollView')).toBeTruthy();
    });
  });
});